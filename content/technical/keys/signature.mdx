---
title: 签名
---

比特币中的签名数据是通过私钥对交易数据进行 `ECDSA` 或 `Schnorr` 签名生成的, 签名数据被放置在交易的 `scriptSig` 或 `witness` 字段中。目的是为了在脚本执行时, 通过 `OP_CHECKSIG` 等操作码的检查, 以确认是否可以花费该 `UTXO`。

交易的签名针对的是特定的交易输入, 多个交易输入需要多个签名。

## 未签名交易

构造未签名交易时, 需要提供:

- 交易输入

  - `txid` - 要花费的 `UTXO` 来自于哪个交易ID
  - `vout` - 要花费的 `UTXO` 来自于交易输出的哪个索引号
  - `scriptSigSize` - `scriptSig` 的字节长度
  - `scriptSig` - 解锁脚本。签名时, 需要暂时替换为要花费的 `UTXO` 的锁定脚本。
  - `sequence` - 设置交易是否可以替换或何时可以挖掘

- 交易输出

  - `amount` - 输出的聪的数量
  - `scriptPubKeySize` - `scriptPubKey` 的字节长度
  - `scriptPubKey` - 锁定脚本。根据接收地址生成的锁定脚本, 例如接收地址是 `P2PKH` 类型, 则锁定脚本格式则为:

<UnSignTransactionBuilder />

## 签名

交易签名数据针对的是特定的交易输入, 对某个输入签名的过程如下:

- 当前需要签名的交易输入的 `ScriptSig` 字段临时替换为要花费的 `UTXO` 的 `scriptPubKey` 字段, 其他交易输入的 `scriptSig` 字段保持为空

- 未签名交易末尾添加哈希类型 `sighash`, 为小端序 4 字节数据, 用于指定签名的数据:

  - `SIGHASH_ALL` - 签名所有输入和输出, 值为 `0x01`
  - `SIGHASH_NONE` - 签名所有输入, 但不签名输出, 值为 `0x02`
  - `SIGHASH_SINGLE` - 签名所有输入, 但只签名对应的输出, 值为 `0x03`
  - `SIGHASH_ANYONECANPAY` - 只签名当前输入, 不签名其他输入和输出, 值为 `0x80`

- 对整个交易进行 `Hash256` 计算, 并生成 `ECDSA` 签名数据

- 将签名数据 `DER` 编码后生成最后签名数据

- 根据花费的 `UTXO` 锁定脚本类型, 生成解锁脚本。

### 替换 ScriptSig

### 添加哈希类型

### 计算签名

### DER 编码

### 生成签名数据

<SignedTransactionBuilder hex='02000000010323f0c5cdd3408336cd7e6b6df9cf0ccde996f363b64a066497a5a60c44f7e4000000001976a914c189d7f7ea4333daec66a645cb3388163c22900b88acffffffff016400000000000000225120b2049a6d884575fe95e3fcaeaedae4ec4feaecccc30fad156f12923753c0954e0000000001000000' />

首先判断是否是 P2TR 锁定。

<TransactionFieldsTable />

## DER 编码

## PSBT

BIP174 定义了部分签名交易格式, 用于多签名交易的签名。
